function drawSunglasses(){let e=[0,0];for(let t=0;t<K_FACE_LEFT_EYE.length-1;t+=1)e[0]+=landmarks[K_FACE_LEFT_EYE[t]][0],e[1]+=landmarks[K_FACE_LEFT_EYE[t]][1];e[0]/=K_FACE_LEFT_EYE.length-1,e[1]/=K_FACE_LEFT_EYE.length-1;let t=[0,0];for(let e=0;e<K_FACE_RIGHT_EYE.length-1;e+=1)t[0]+=landmarks[K_FACE_RIGHT_EYE[e]][0],t[1]+=landmarks[K_FACE_RIGHT_EYE[e]][1];t[0]/=K_FACE_RIGHT_EYE.length-1,t[1]/=K_FACE_RIGHT_EYE.length-1;const a=new Phaser.Line(e[0]+userVideoSprite.position.x,e[1]+userVideoSprite.position.y,t[0]+userVideoSprite.position.x,t[1]+userVideoSprite.position.y),i=a.length/200;sunglasses.scale.setTo(i,i),sunglasses.position=a.midPoint(),sunglasses.rotation=a.angle,sunglasses.visible=!0}function handleValidationDetections(e){if(e){const t=e.landmarks._positions;landmarks=new Array;for(let e=0;e<t.length;e+=1)landmarks.push([t[e]._x*userVideoSprite.scale.x*K_FACE_CV_DOWNRES_FACTOR,t[e]._y*userVideoSprite.scale.y*K_FACE_CV_DOWNRES_FACTOR]);if(e.expressions?(validationStateFaceData.length<2e5&&handleViewerFaceData(validateFrame,validationStateFaceData,landmarks,e.expressions),emotions=e.expressions):validationStateFaceData.length<2e5&&handleViewerFaceData(validateFrame,validationStateFaceData,landmarks,null),K_INSTALLATION_MODE){const t=new viewerFaceDataStruct(validateFrame,landmarks,e.expressions||null);socket.emit("data",t)}}else landmarks=!1,emotions=!1,K_INSTALLATION_MODE&&socket.emit("data",null)}const validateState={create:function(){function e(){if(hasStarted=!0,logoSprite.inputEnabled=!1,pressRedButtonToStart.visible=!1,faceCameraAndCheckLighting.visible=!1,K_LOGO_ANIMATION){logoAnimationTimer=game.time.create(!1);let e=78;logoAnimationTimer.loop(30,()=>{logoSprite.loadTexture(`logoFrame${e}`),0===e?(logoAnimationTimer.stop(),game.camera.onFadeComplete.addOnce(()=>{notValidatedTimer.stop(),validatedTimer.stop(),game.state.start("dataInit")}),game.camera.fade(0,300)):e-=1},this),logoAnimationTimer.start()}else game.camera.onFadeComplete.addOnce(()=>{notValidatedTimer.stop(),validatedTimer.stop(),game.state.start("dataInit")}),game.camera.fade(0,300)}K_MULTITHREADING&&(cvWorker.onmessage=function(e){1===e.data.opcode&&handleValidationDetections(e.data.dets)}),game.camera.flash(0,1e3,!1),debounceHandle=null,validateFrame=0,readyToPlay=!1,hasStarted=!1,validationStateFaceData=[],cvSprite=game.add.sprite(0,0,userVideo),cvSprite.visible=!1,clmCanvas=game.add.bitmapData(Math.round(cvSprite.width/K_FACE_CV_DOWNRES_FACTOR),Math.round(cvSprite.height/K_FACE_CV_DOWNRES_FACTOR)),dogLoopVideo=game.add.video("dogloop"),dogLoopSprite=game.add.sprite(K_PROJECT_WIDTH/4,0,dogLoopVideo),dogLoopVideo.play(!0,1),userVideoSprite=game.add.sprite(0,0,userVideo);const t=K_PROJECT_WIDTH/(userVideo.height*K_PROJECT_ASPECT_RATIO);userVideoSprite.scale.setTo(t,t),userVideoMaskQuarterRight=game.make.graphics(0,0),userVideoMaskQuarterRight.beginFill(16777215),userVideoMaskQuarterRight.drawRect(0,0,K_PROJECT_WIDTH/2,K_PROJECT_HEIGHT),userVideoSprite.mask=userVideoMaskQuarterRight,userVideoSprite.position.x=-userVideoSprite.width/4,sunglasses=game.add.sprite(0,0,"sunglasses"),sunglasses.anchor.setTo(.5,.5),sunglasses.visible=!1;const a=game.add.sprite(0,0,"webbyLaurel");a.scale.setTo(.5,.5),a.anchor.setTo(0,0),a.position={x:10,y:10};const i=game.add.text(0,0,'"meet the new A.I. \nthat knows you better \nthan you know yourself" ',{font:"Arimo, sans-serif",strokeThickness:5,fontStyle:"italic",fontSize:"30px",fontWeight:"bold",fill:"#00ffff",align:"right"});i.lineSpacing=-10,i.setShadow(2,2,"#000000"),i.anchor.setTo(1,0),i.position={x:K_PROJECT_WIDTH-20,y:20};const o=game.add.text(0,0," written, directed and programmed \n by noah levenson  (6 min) ",{font:"Arimo, sans-serif",strokeThickness:5,fontStyle:"italic",fontSize:"20px",fontWeight:"bold",fill:"#ffffff",align:"right"});o.lineSpacing=-5,o.setShadow(2,2,"#000000"),o.anchor.setTo(1,0),o.position={x:K_PROJECT_WIDTH-20,y:20+i.height};const n=game.add.sprite(0,0,"tribecaLaurel");n.scale.setTo(.5,.5),n.anchor.setTo(1,0),n.position={x:K_PROJECT_WIDTH-20,y:o.y+o.height+5};const s=game.add.sprite(0,0,"ciffLaurel");s.scale.setTo(.5,.5),s.anchor.setTo(1,0),s.position={x:K_PROJECT_WIDTH-20,y:n.y+n.height+5};const r=game.add.sprite(0,0,"ridmLaurel");r.scale.setTo(.5,.5),r.anchor.setTo(1,0),r.position={x:K_PROJECT_WIDTH-20,y:s.y+s.height+5};const l=game.add.sprite(0,0,"opencityLaurel");if(l.scale.setTo(.5,.5),l.anchor.setTo(1,0),l.position={x:K_PROJECT_WIDTH-20,y:r.y+r.height+5},K_LOGO_ANIMATION){logoSprite=game.add.sprite(0,0,"logoFrame0"),logoSprite.scale.setTo(.65,.65),logoSprite.anchor.setTo(.5,.5),logoSprite.position={x:K_PROJECT_WIDTH/2,y:K_PROJECT_HEIGHT/2},logoSprite.hitArea=new Phaser.Circle(0,0,700);let e=1;logoAnimationTimer=game.time.create(!1),logoAnimationTimer.loop(30,()=>{logoSprite.loadTexture(`logoFrame${e}`),79===e?(logoAnimationTimer.stop(),readyToPlay=!0):e+=1},this),logoAnimationTimer.start()}else logoSprite=game.add.sprite(0,0,"logoFrame79"),logoSprite.scale.setTo(.65,.65),logoSprite.anchor.setTo(.5,.5),logoSprite.position={x:K_PROJECT_WIDTH/2,y:K_PROJECT_HEIGHT/2},logoSprite.hitArea=new Phaser.Circle(0,0,700),readyToPlay=!0;pressRedButtonToStart=game.add.text(0,0,"click smiley to start ",{font:"Arimo, sans-serif",strokeThickness:5,fontStyle:"italic",fontSize:"40px",fontWeight:"bold",fill:"#ffff1a",align:"right"}),pressRedButtonToStart.setShadow(2,2,"#000000"),pressRedButtonToStart.anchor.setTo(.5,.5),pressRedButtonToStart.position={x:K_PROJECT_WIDTH/2,y:K_PROJECT_HEIGHT-75},pressRedButtonToStart.visible=!1,faceCameraAndCheckLighting=game.add.text(0,0,"face camera and check lighting ",{font:"Arimo, sans-serif",strokeThickness:5,fontStyle:"italic",fontSize:"40px",fontWeight:"bold",fill:"#ff0066",align:"right"}),faceCameraAndCheckLighting.setShadow(2,2,"#000000"),faceCameraAndCheckLighting.anchor.setTo(.5,.5),faceCameraAndCheckLighting.position={x:K_PROJECT_WIDTH/2,y:K_PROJECT_HEIGHT-75},faceCameraAndCheckLighting.visible=!0,notValidatedTimer=game.time.create(!1),notValidatedTimer.loop(600,()=>{faceCameraAndCheckLighting.text=""===faceCameraAndCheckLighting.text?"face camera and check lighting ":""}),notValidatedTimer.start(),validatedTimer=game.time.create(!1),validatedTimer.loop(200,()=>{pressRedButtonToStart.text=""===pressRedButtonToStart.text?"click smiley to start ":""}),validatedTimer.start(),K_MOBILE&&(mobileTapText=game.add.text(0,0,"tap",{font:"Arimo, sans-serif",fontSize:"44px",fill:"rgba(255, 255, 255, 0.5)"}),mobileTapText.anchor.setTo(.5,.5),mobileTapText.position={x:.75*K_PROJECT_WIDTH,y:K_PROJECT_HEIGHT/2},game.input.onTap.addOnce(()=>{mobileTapText.visible=!1})),K_MOBILE||(fullScreenButton=game.add.sprite(1205,645,"fullscreenButton"),fullScreenButton.scale.setTo(.75,.75),fullScreenButton.tint=9211020,fullScreenButton.events.onInputOver.add(function(){fullScreenButton.tint=16777215}),fullScreenButton.events.onInputOut.add(function(){fullScreenButton.tint=9211020}),fullScreenButton.events.onInputDown.add(function(){game.scale.startFullScreen(),fullScreenButton.tint=9211020,K_INSTALLATION_MODE&&(game.canvas.style.cursor="none")}),fullScreenButton.visible=!1,fullScreenButton.inputEnabled=!0,fullScreenButton.input.useHandCursor=!0),logoSprite.events.onInputDown.addOnce(e),game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR).onDown.add(()=>{logoSprite.inputEnabled&&(game.input.keyboard.removeKey(Phaser.Keyboard.SPACEBAR),e())})},update:async function(){if(validateFrame%K_CV_REFRESH_INTERVAL==0)if(K_MULTITHREADING)createImageBitmap(userVideo.video).then(e=>{cvWorker.postMessage({fakeWindow:fakeWindow,fakeDocument:fakeDocument,img:e,opcode:1,getEmotions:!0,frame:validateFrame},[e])});else{updateCLM(clmCanvas);const e=new faceapi.TinyFaceDetectorOptions({inputSize:160,scoreThreshold:.5});let t;K_RUN_CV_ASYNC?(t=faceapi.detectSingleFace(clmCanvas.canvas,e).withFaceLandmarks(!0).withFaceExpressions()).then(e=>{handleValidationDetections(e)}):handleValidationDetections(t=await faceapi.detectSingleFace(clmCanvas.canvas,e).withFaceLandmarks(!0).withFaceExpressions())}landmarks?(validateFrame%K_AR_FRAME_INTERVAL==0&&drawSunglasses(landmarks),null===debounceHandle&&readyToPlay&&(debounceHandle=setTimeout(()=>{landmarks&&(hasStarted||(faceCameraAndCheckLighting.visible=!1,pressRedButtonToStart.visible=!0,logoSprite.inputEnabled=!0,logoSprite.input.useHandCursor=!0))},K_VALIDATE_DEBOUNCE_DELAY))):(clearTimeout(debounceHandle),debounceHandle=null,sunglasses.visible=!1,hasStarted||(pressRedButtonToStart.visible=!1,faceCameraAndCheckLighting.visible=!0),logoSprite.inputEnabled=!1),validateFrame+=1,K_MOBILE||(game.scale.isFullScreen?fullScreenButton.visible=!1:fullScreenButton.visible=!0)}};