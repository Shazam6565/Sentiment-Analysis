function handlePetitionDetections(e){if(e){const t=e.landmarks._positions;landmarks=new Array;for(let e=0;e<t.length;e+=1)landmarks.push([t[e]._x*userVideoSprite.scale.x*K_FACE_CV_DOWNRES_FACTOR,t[e]._y*userVideoSprite.scale.y*K_FACE_CV_DOWNRES_FACTOR]);if(e.expressions&&(emotions=e.expressions),K_INSTALLATION_MODE){const t=new viewerFaceDataStruct(petitionFrame,landmarks,e.expressions||null);socket.emit("data",t)}}else landmarks=!1,emotions=!1,K_INSTALLATION_MODE&&socket.emit("data",null)}const petitionState={create:function(){K_MULTITHREADING&&(cvWorker.onmessage=function(e){1===e.data.opcode&&handlePetitionDetections(e.data.dets)}),game.camera.flash(0,1e3,!1),petitionFrame=0,redirectionInitiated=!1,cvSprite=game.add.sprite(0,0,userVideo),cvSprite.visible=!1,clmCanvas=game.add.bitmapData(Math.round(cvSprite.width/K_FACE_CV_DOWNRES_FACTOR),Math.round(cvSprite.height/K_FACE_CV_DOWNRES_FACTOR)),userVideoSprite=game.add.sprite(0,0,userVideo);const e=K_PROJECT_WIDTH/(userVideo.height*K_PROJECT_ASPECT_RATIO);userVideoSprite.scale.setTo(e,e),userVideoSprite.visible=!1;const t=game.add.text(0,0,"Tell Snap to disclose if it is already using emotion recognition technology.",{font:"Arimo, sans-serif",fontSize:"40px",fontWeight:"bold",fill:"#FFFFFF"});t.wordWrapWidth=760,t.wordWrap=!0,t.anchor.setTo(.5,.5),t.position={x:K_PROJECT_WIDTH/2,y:K_PROJECT_HEIGHT/2-150};const i=game.add.text(0,0,"*Data about your smile and face will not be stored nor used for any purpose other than launching ",{font:"Arimo, sans-serif",fontSize:"12px",fontWeight:"bold",fill:"#cccccc"});i.anchor.setTo(0,0),i.position={x:t.x-t.width/2,y:K_PROJECT_HEIGHT-100};const n=game.add.text(0,0,"this website",{font:"Arimo, sans-serif",fontSize:"12px",fontWeight:"bold",fill:"#e6e6e6"});n.anchor.setTo(0,0),n.position={x:i.x+i.width,y:i.y},n.inputEnabled=!0,n.input.useHandCursor=!0,n.events.onInputOver.add(()=>{n.fill="#ffffff"}),n.events.onInputOut.add(()=>{n.fill="#e6e6e6"}),n.events.onInputDown.add(()=>{window.location.href="https://foundation.mozilla.org/en/campaigns/snapchat-stop-stealing-our-feelings/"});const o=game.add.text(0,0,"To read and sign Mozilla's petition, just ",{font:"Arimo, sans-serif",fontSize:"27px",fontWeight:"bold",fill:"#ffff1a"});o.anchor.setTo(0,0),o.position={x:t.x-t.width/2,y:t.y+t.height/2+16};const a=game.add.text(0,0,"smile ",{font:"Arimo, sans-serif",fontSize:"27px",fontWeight:"bold",fill:"#ffff1a"});a.anchor.setTo(0,0),a.position={x:o.x+o.width,y:o.y};const s=game.time.create(!1);s.loop(400,()=>{a.visible=!a.visible},this),s.start(),petitionSmileGfx=game.add.graphics(0,0),redirectingText=game.add.text(0,0,"Redirecting...",{font:"Arimo, sans-serif",fontSize:"20px",fontWeight:"bold",fill:"#ffffff"}),redirectingText.anchor.setTo(.5,.5),redirectingText.position={x:K_PROJECT_WIDTH/2,y:K_PROJECT_HEIGHT/2+160},redirectingText.visible=!1,noPetitionFaceDetectedText=game.add.text(0,0,"face camera and check lighting",{font:"Arimo, sans-serif",fontSize:"20px",fontWeight:"bold",fill:"#404040"}),noPetitionFaceDetectedText.anchor.setTo(.5,.5),noPetitionFaceDetectedText.position={x:K_PROJECT_WIDTH/2,y:K_PROJECT_HEIGHT/2+20},noPetitionFaceDetectedText.visible=!1;const l=game.add.text(0,0,"(or click here)",{font:"Arimo, sans-serif",fontSize:"27px",fontWeight:"bold",fill:"#ffff1a"});l.anchor.setTo(0,0),l.position={x:a.x+a.width,y:o.y},l.visible=!1,userFailedToSmileTimeout=setTimeout(()=>{l.alpha=0,l.visible=!0;game.add.tween(l).to({alpha:1},2e3,Phaser.Easing.Linear.None,!0,0,0,!1);l.inputEnabled=!0,l.input.useHandCursor=!0,l.events.onInputOver.add(()=>{l.fill="#ffff99"}),l.events.onInputOut.add(()=>{l.fill="#ffff1a"}),l.events.onInputDown.add(()=>{window.location.href="https://foundation.mozilla.org/en/campaigns/snapchat-stop-stealing-our-feelings/"})},1e4),K_MOBILE||(fullScreenButton=game.add.sprite(1205,645,"fullscreenButton"),fullScreenButton.scale.setTo(.75,.75),fullScreenButton.tint=9211020,fullScreenButton.events.onInputOver.add(function(){fullScreenButton.tint=16777215}),fullScreenButton.events.onInputOut.add(function(){fullScreenButton.tint=9211020}),fullScreenButton.events.onInputDown.add(function(){game.scale.startFullScreen(),fullScreenButton.tint=9211020,K_INSTALLATION_MODE&&(game.canvas.style.cursor="none")}),fullScreenButton.visible=!1,fullScreenButton.inputEnabled=!0,fullScreenButton.input.useHandCursor=!0);const r=game.time.create(!1);r.add(3e4,()=>{redirectionInitiated||(redirectionInitiated=!0,game.camera.fade(0,500),game.camera.onFadeComplete.addOnce(()=>{s.stop(),s.destroy(),game.state.start("validate")}))},this),r.start()},update:async function(){if(petitionFrame%K_CV_REFRESH_INTERVAL==0)if(K_MULTITHREADING)createImageBitmap(userVideo.video).then(e=>{cvWorker.postMessage({fakeWindow:fakeWindow,fakeDocument:fakeDocument,img:e,opcode:1,getEmotions:!0,frame:petitionFrame},[e])});else{updateCLM(clmCanvas);const e=new faceapi.TinyFaceDetectorOptions({inputSize:160,scoreThreshold:.5});let t;K_RUN_CV_ASYNC?(t=faceapi.detectSingleFace(clmCanvas.canvas,e).withFaceLandmarks(!0).withFaceExpressions()).then(e=>{handlePetitionDetections(e)}):handlePetitionDetections(t=await faceapi.detectSingleFace(clmCanvas.canvas,e).withFaceLandmarks(!0).withFaceExpressions())}if(emotions){landmarks&&function(e){const t=[];for(let i=0;i<e.length;i+=1)t.push([e[i][0],e[i][1]]);for(let e=0;e<t.length;e+=1)t[e][0]*=4,t[e][1]*=4;const i=K_PROJECT_WIDTH/2-t[51][0],n=K_PROJECT_HEIGHT/2-t[51][1];for(let e=0;e<t.length;e+=1)t[e][0]+=i,t[e][1]+=n;petitionSmileGfx.visible=!0,petitionSmileGfx.clear(),petitionSmileGfx.lineStyle(6,16711680,1),petitionSmileGfx.moveTo(t[K_FACE_MOUTH_OUTER[0]][0],t[K_FACE_MOUTH_OUTER[0]][1]);for(let e=1;e<K_FACE_MOUTH_OUTER.length;e+=1)petitionSmileGfx.lineTo(t[K_FACE_MOUTH_OUTER[e]][0],t[K_FACE_MOUTH_OUTER[e]][1]);petitionSmileGfx.moveTo(t[K_FACE_MOUTH_INNER_TOP[0]][0],t[K_FACE_MOUTH_INNER_TOP[0]][1]);for(let e=1;e<K_FACE_MOUTH_INNER_TOP.length;e+=1)petitionSmileGfx.lineTo(t[K_FACE_MOUTH_INNER_TOP[e]][0],t[K_FACE_MOUTH_INNER_TOP[e]][1]);petitionSmileGfx.moveTo(t[K_FACE_MOUTH_INNER_BOTTOM[0]][0],t[K_FACE_MOUTH_INNER_BOTTOM[0]][1]);for(let e=1;e<K_FACE_MOUTH_INNER_BOTTOM.length;e+=1)petitionSmileGfx.lineTo(t[K_FACE_MOUTH_INNER_BOTTOM[e]][0],t[K_FACE_MOUTH_INNER_BOTTOM[e]][1]);redirectingText.position={x:t[K_FACE_MOUTH_OUTER[6]][0]+100,y:t[K_FACE_MOUTH_OUTER[6]][1]}}(landmarks),emotions.happy>.9&&!1===redirectionInitiated&&(redirectionInitiated=!0,clearTimeout(userFailedToSmileTimeout),redirectingText.visible=!0,setTimeout(()=>{window.location.href="https://foundation.mozilla.org/en/campaigns/snapchat-stop-stealing-our-feelings/"},2e3))}else petitionSmileGfx.clear();petitionFrame+=1,K_MOBILE||(game.scale.isFullScreen?fullScreenButton.visible=!1:fullScreenButton.visible=!0)}};